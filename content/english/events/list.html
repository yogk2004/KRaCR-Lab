{{ define "main" }}
{{ partial "page-header" . }}

<section class="section">
  <div class="container">
    <div class="row gx-5">
      <!-- Blog posts grouped by category -->
      <div class="lg:col-12">
        <!-- Collect all pages -->
        {{ $pages := .RegularPages.ByDate.Reverse }}
        <!-- Debugging: Output total number of pages -->
        <p>Debug: Total pages found: {{ len $pages }}</p>

        <!-- Collect unique categories -->
        {{ $categories := slice }}
        {{ range $pages }}
        {{ if .Params.categories }}
        {{ range .Params.categories }}
        {{ $categories = $categories | append . }}
        {{ end }}
        {{ else }}
        {{ $categories = $categories | append "Uncategorized" }}
        {{ end }}
        {{ end }}
        {{ $categories = $categories | uniq | sort }}

        <!-- Debugging: Output unique categories -->
        <p>Debug: Categories found: {{ $categories }}</p>

        <!-- Iterate over unique categories -->
        {{ range $category := $categories }}
        <div class="category-section mb-10">
          <h2 class="mb-6">{{ $category | title }}</h2>
          <div class="row">
            <!-- Filter pages by current category -->
            {{ $matchingPages := where $pages "Params.categories" "intersect" (slice $category) }}
            <!-- Debugging: Output number of matching pages -->
            <p>Debug: Posts in category "{{ $category }}": {{ len $matchingPages }}</p>
            {{ if $matchingPages }}
            {{ range $matchingPages }}
            <div class="col-md-4 mb-14">
              {{ partial "components/blog-card" . }}
            </div>
            {{ end }}
            {{ else }}
            <p>No posts found for category "{{ $category }}".</p>
            {{ end }}
          </div>
        </div>
        {{ end }}

        <!-- Pagination (optional, may need adjustment) -->
        {{ partial "components/pagination.html" . }}
      </div>
    </div>
  </div>
</section>
{{ end }}